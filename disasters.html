<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster Readiness Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;600;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            transition: all 0.15s ease-in-out;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        /* Custom Checkbox/Radio Styling */
        input[type="checkbox"], input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            width: 1.5rem;
            height: 1.5rem;
            border: 2px solid #6366f1;
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            margin-right: 0.5rem;
            position: relative;
            top: 4px;
        }
        input[type="checkbox"]:checked, input[type="radio"]:checked {
            background-color: #6366f1;
            border-color: #6366f1;
        }
        input[type="checkbox"]:checked::after, input[type="radio"]:checked::after {
            content: '‚úì';
            display: block;
            color: white;
            font-size: 1rem;
            text-align: center;
            line-height: 1.3;
        }
        input[type="radio"] {
            border-radius: 50%; /* Make radio buttons round */
        }
        input[type="radio"]:checked::after {
             content: '‚Ä¢';
             font-size: 2rem;
             line-height: 0.6;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div id="game-container" class="w-full max-w-2xl">
        
        <!-- Header / Scoreboard -->
        <header class="text-center mb-6 bg-white p-4 rounded-xl card border-b-4 border-indigo-500">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-1">Disaster Readiness Challenge</h1>
            <p class="text-sm text-gray-500">Match causes and actions to maximize your score!</p>
            <div class="flex justify-between items-center mt-3 text-lg font-semibold">
                <div class="text-red-600">Time: <span id="time-display">0</span>s</div>
                <div class="text-green-600">Score: <span id="score-display">0</span></div>
            </div>
        </header>

        <!-- Game Content Area -->
        <main id="game-screen" class="bg-white p-6 rounded-xl card min-h-[400px] flex flex-col justify-center">
            <!-- Content will be injected here (Start, Selection, Quiz, Score) -->
        </main>
        
    </div>

    <script>
        // --- Game Data ---
        const DISASTER_DATA = [
            {
                name: "Earthquake",
                icon: "üåç", // Added icon
                color: "bg-red-500",
                causeType: "Geological/Tectonic",
                causes: [
                    { text: "Movement along active fault lines (Tectonic Plates)", isCorrect: true },
                    { text: "Prolonged period of heavy rainfall", isCorrect: false },
                    { text: "Sudden release of magma beneath the surface", isCorrect: false },
                    { text: "Build-up of pressure from water reservoirs", isCorrect: true } // Man-made cause
                ],
                actions: [
                    { text: "Drop, Cover, and Hold On during the shaking", isCorrect: true },
                    { text: "Evacuate to higher ground immediately", isCorrect: false },
                    { text: "Secure heavy furniture and water heaters to walls", isCorrect: true },
                    { text: "Use sandbags to redirect flood water", isCorrect: false }
                ]
            },
            {
                name: "Tornado",
                icon: "üå™Ô∏è", // Added icon
                color: "bg-yellow-500",
                causeType: "Meteorological/Atmospheric",
                causes: [
                    { text: "Warm, moist air meeting cool, dry air (Supercell)", isCorrect: true },
                    { text: "Weakening of ocean currents in the equatorial zone", isCorrect: false },
                    { text: "Strong wind shear and unstable atmospheric conditions", isCorrect: true },
                    { text: "Low-pressure systems forming over warm ocean water", isCorrect: false }
                ],
                actions: [
                    { text: "Seek shelter in a basement or interior room without windows", isCorrect: true },
                    { text: "Open all windows to equalize pressure", isCorrect: false },
                    { text: "Wear a helmet to protect against flying debris", isCorrect: true },
                    { text: "Turn off the main gas line before seeking shelter", isCorrect: false }
                ]
            },
            {
                name: "Flood (River/Flash)",
                icon: "üíß", // Added icon
                color: "bg-blue-500",
                causeType: "Hydrological/Environmental",
                causes: [
                    { text: "Prolonged, intense rainfall or rapid snowmelt", isCorrect: true },
                    { text: "Failure of dams or levees", isCorrect: true },
                    { text: "Tectonic activity causing ground subsidence", isCorrect: false },
                    { text: "Coastal surge from a tropical storm", isCorrect: false } // A specific type, but not the main river/flash cause
                ],
                actions: [
                    { text: "Never drive or walk through floodwaters", isCorrect: true },
                    { text: "Turn off utilities (electricity/gas) if safe to do so", isCorrect: true },
                    { text: "Stay close to large trees for wind protection", isCorrect: false },
                    { text: "Evacuate to a designated safe zone on higher ground", isCorrect: true }
                ]
            },
            {
                name: "Wildfire",
                icon: "üî•", // Added icon
                color: "bg-orange-500",
                causeType: "Environmental/Human",
                causes: [
                    { text: "Periods of prolonged drought and high temperatures", isCorrect: true },
                    { text: "Natural causes like lightning strikes", isCorrect: true },
                    { text: "Unattended campfires or discarded smoking materials", isCorrect: true },
                    { text: "Deep-sea thermal vent activity", isCorrect: false }
                ],
                actions: [
                    { text: "Clear brush, leaves, and debris around your home (Defensible Space)", isCorrect: true },
                    { text: "Fill sandbags to protect vulnerable structures", isCorrect: false },
                    { text: "Use an N95 respirator mask to protect from smoke", isCorrect: true },
                    { text: "Keep important documents ready in an evacuation kit", isCorrect: true }
                ]
            },
            // --- NEW DISASTERS ADDED ---
            {
                name: "Volcano",
                icon: "üåã",
                color: "bg-purple-600",
                causeType: "Geological",
                causes: [
                    { text: "Movement of magma beneath the crust", isCorrect: true },
                    { text: "Build-up of gas pressure in the magma chamber", isCorrect: true },
                    { text: "Rapid melting of polar ice caps", isCorrect: false },
                    { text: "Strong wind shear in the atmosphere", isCorrect: false }
                ],
                actions: [
                    { text: "Follow evacuation orders immediately", isCorrect: true },
                    { text: "Wear long-sleeved shirts and goggles to protect from ash", isCorrect: true },
                    { text: "Close windows, doors, and vents to prevent ash entry", isCorrect: true },
                    { text: "Seek shelter in a small, windowless interior room", isCorrect: false }
                ]
            },
            {
                name: "Tsunami",
                icon: "üåä",
                color: "bg-indigo-600",
                causeType: "Hydrological/Geological",
                causes: [
                    { text: "Large underwater earthquake or landslide", isCorrect: true },
                    { text: "Volcanic eruptions or meteorite impact in the ocean", isCorrect: true },
                    { text: "Prolonged drought conditions", isCorrect: false },
                    { text: "Formation of a supercell thunderstorm", isCorrect: false }
                ],
                actions: [
                    { text: "Move immediately to high ground and inland", isCorrect: true },
                    { text: "Never go to the shore to watch a tsunami", isCorrect: true },
                    { text: "Be aware that a series of waves may follow the first wave", isCorrect: true },
                    { text: "Turn off utilities and secure non-structural elements", isCorrect: false }
                ]
            }
            // --- END NEW DISASTERS ---
        ];

        // --- Game State ---
        let state = {
            view: 'start', // 'start', 'selection', 'causes', 'actions', 'score'
            score: 0,
            highScore: localStorage.getItem('disasterHighScore') ? parseInt(localStorage.getItem('disasterHighScore')) : 0,
            timer: 0,
            interval: null,
            currentDisaster: null,
            currentLevel: 0, // 0: Causes, 1: Actions
        };

        // --- DOM Elements ---
        const gameScreen = document.getElementById('game-screen');
        const scoreDisplay = document.getElementById('score-display');
        const timeDisplay = document.getElementById('time-display');

        // --- Utility Functions ---

        /**
         * Shuffles an array in place using the Fisher-Yates algorithm.
         * @param {Array} a The array to shuffle.
         */
        const shuffleArray = (a) => {
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        };

        // --- Timer and Score Management ---

        const startTimer = () => {
            if (state.interval) clearInterval(state.interval);
            state.interval = setInterval(() => {
                state.timer++;
                timeDisplay.textContent = state.timer;
            }, 1000);
        };

        const stopTimer = () => {
            clearInterval(state.interval);
            state.interval = null;
        };

        const updateScore = (points) => {
            state.score += points;
            scoreDisplay.textContent = state.score;
        };

        const saveHighScore = () => {
            if (state.score > state.highScore) {
                state.highScore = state.score;
                localStorage.setItem('disasterHighScore', state.highScore);
                return true;
            }
            return false;
        };

        // --- Game Views ---

        const renderStartScreen = () => {
            stopTimer();
            state.score = 0;
            state.timer = 0;
            scoreDisplay.textContent = state.score;
            timeDisplay.textContent = state.timer;

            gameScreen.innerHTML = `
                <div class="text-center p-4">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome, Disaster Planner!</h2>
                    <p class="text-gray-600 mb-8">Your mission is to correctly match the <strong>Causes</strong> and <strong>Mitigation Actions</strong> for a chosen disaster as quickly as possible.</p>
                    
                    <div class="bg-indigo-50 p-4 rounded-lg mb-8 inline-block">
                        <p class="text-lg font-semibold text-indigo-700">High Score: <span class="font-extrabold">${state.highScore}</span></p>
                    </div>

                    <button id="start-btn" class="w-full md:w-auto px-8 py-3 bg-indigo-600 text-white text-xl font-bold rounded-xl btn-primary hover:bg-indigo-700">
                        Start Challenge
                    </button>
                </div>
            `;
            document.getElementById('start-btn').addEventListener('click', () => {
                state.view = 'selection';
                renderGame();
            });
        };

        const renderSelectionScreen = () => {
            gameScreen.innerHTML = `
                <div class="text-center p-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Step 1: Choose Your Disaster</h2>
                    <p class="text-gray-600 mb-6">Select one natural disaster to focus on for this challenge round:</p>
                    
                    <!-- Updated grid for 6 items (2 columns on mobile, 3 on larger screens) -->
                    <div id="disaster-options" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        ${DISASTER_DATA.map((d, index) => `
                            <button data-index="${index}" class="disaster-select-btn p-4 rounded-xl ${d.color} text-white font-semibold text-xl hover:opacity-90 transition transform hover:scale-[1.02] active:scale-100 flex flex-col items-center justify-center h-32">
                                <span class="text-4xl mb-1">${d.icon}</span>
                                <span class="text-base font-semibold">${d.name}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;

            document.querySelectorAll('.disaster-select-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index')); // Use currentTarget for button element
                    state.currentDisaster = DISASTER_DATA[index];
                    state.currentLevel = 0; // Start with Causes
                    state.view = 'causes';
                    startTimer();
                    renderGame();
                });
            });
        };

        const renderQuizScreen = () => {
            if (!state.currentDisaster) return;

            const isCausesLevel = state.currentLevel === 0;
            const data = isCausesLevel ? state.currentDisaster.causes : state.currentDisaster.actions;
            const title = isCausesLevel ? "2. Identify Possible Causes" : "3. Select Mitigation Actions";
            const instructions = isCausesLevel 
                ? `Select <strong>ALL</strong> statements that are considered common causes for a ${state.currentDisaster.name}.`
                : `Select the <strong>BEST</strong> actions to mitigate the effects of a ${state.currentDisaster.name}.`;
            const formId = isCausesLevel ? 'causes-form' : 'actions-form';

            // Shuffle the options before rendering
            shuffleArray(data);

            gameScreen.innerHTML = `
                <div class="p-4">
                    <div class="text-center mb-6">
                        <div class="inline-block px-4 py-2 text-white font-extrabold rounded-full text-lg ${state.currentDisaster.color}">${state.currentDisaster.icon} ${state.currentDisaster.name}</div>
                    </div>
                    
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">${title}</h2>
                    <p class="text-gray-600 mb-6">${instructions}</p>
                    
                    <form id="${formId}" class="space-y-4">
                        ${data.map((item, index) => `
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition">
                                <input type="checkbox" name="option" value="${index}" data-correct="${item.isCorrect}" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500">
                                <span class="ml-3 text-base text-gray-700">${item.text}</span>
                            </label>
                        `).join('')}
                    </form>

                    <button id="submit-quiz-btn" class="mt-8 w-full px-6 py-3 bg-green-600 text-white text-lg font-bold rounded-xl btn-primary hover:bg-green-700">
                        Submit Answers
                    </button>
                </div>
            `;

            document.getElementById('submit-quiz-btn').addEventListener('click', () => submitQuiz(data));
        };

        const submitQuiz = (optionsData) => {
            const isCausesLevel = state.currentLevel === 0;
            const formId = isCausesLevel ? 'causes-form' : 'actions-form';
            const form = document.getElementById(formId);
            if (!form) return;

            const selectedInputs = Array.from(form.querySelectorAll('input[name="option"]:checked'));
            
            let correctSelections = 0;
            let incorrectSelections = 0;
            let missedCorrect = 0;
            const totalCorrect = optionsData.filter(item => item.isCorrect).length;

            // 1. Check selected items
            selectedInputs.forEach(input => {
                const isCorrect = input.getAttribute('data-correct') === 'true';
                if (isCorrect) {
                    correctSelections++;
                } else {
                    incorrectSelections++;
                }
            });

            // 2. Check missed correct items (unselected but should be correct)
            optionsData.forEach((item, index) => {
                if (item.isCorrect) {
                    const isSelected = selectedInputs.some(input => parseInt(input.value) === index);
                    if (!isSelected) {
                        missedCorrect++;
                    }
                }
            });

            // Scoring Logic:
            // +10 points for each correct selection
            // -15 points for each incorrect selection (penalty)
            // -5 points for each missed correct answer (oversight penalty)

            const scoreChange = (correctSelections * 10) - (incorrectSelections * 15) - (missedCorrect * 5);
            updateScore(scoreChange);

            // Give feedback and proceed
            displayFeedback(optionsData, selectedInputs, scoreChange, totalCorrect, missedCorrect, incorrectSelections);
        };

        const displayFeedback = (optionsData, selectedInputs, scoreChange, totalCorrect, missedCorrect, incorrectSelections) => {
            const isCausesLevel = state.currentLevel === 0;
            const nextBtnText = isCausesLevel ? 'Continue to Actions' : 'View Final Score';
            
            stopTimer();

            // Highlight results
            const feedbackHTML = optionsData.map((item, index) => {
                const input = selectedInputs.find(i => parseInt(i.value) === index);
                const isSelected = !!input;
                
                let bgColor = '';
                let icon = '';
                let text = '';

                if (item.isCorrect && isSelected) {
                    bgColor = 'bg-green-100 border-green-500'; // Correctly selected
                    icon = '‚úÖ';
                    text = 'Correct Match!';
                } else if (!item.isCorrect && isSelected) {
                    bgColor = 'bg-red-100 border-red-500'; // Incorrectly selected (Penalty)
                    icon = '‚ùå';
                    text = 'Incorrect Selection! (Penalty)';
                } else if (item.isCorrect && !isSelected) {
                    bgColor = 'bg-yellow-100 border-yellow-500'; // Missed (Oversight Penalty)
                    icon = '‚ö†Ô∏è';
                    text = 'Missed! This was a correct answer.';
                } else {
                    bgColor = 'bg-gray-50 border-gray-200'; // Correctly left unselected
                    icon = '‚ûñ';
                    text = 'Correctly excluded.';
                }

                return `
                    <div class="flex items-start p-3 border rounded-lg ${bgColor} text-gray-800">
                        <span class="mr-3 text-2xl">${icon}</span>
                        <div>
                            <p class="font-semibold">${item.text}</p>
                            <p class="text-sm italic text-gray-600">${text}</p>
                        </div>
                    </div>
                `;
            }).join('');

            const summary = `
                <div class="bg-indigo-50 p-4 rounded-lg mb-6 text-center">
                    <p class="text-lg font-bold text-indigo-700">Score Change: <span class="text-3xl ${scoreChange >= 0 ? 'text-green-600' : 'text-red-600'}">${scoreChange >= 0 ? '+' : ''}${scoreChange}</span></p>
                    <p class="text-sm text-gray-600 mt-2">
                        Correct: ${totalCorrect - missedCorrect} / ${totalCorrect} | 
                        Incorrect Selections: ${incorrectSelections}
                    </p>
                </div>
            `;
            
            gameScreen.innerHTML = `
                <div class="p-4">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Feedback: ${isCausesLevel ? 'Causes' : 'Actions'}</h2>
                    <div class="text-center mb-6">
                        <div class="inline-block px-4 py-2 text-white font-extrabold rounded-full text-lg ${state.currentDisaster.color}">${state.currentDisaster.icon} ${state.currentDisaster.name}</div>
                    </div>

                    ${summary}
                    
                    <div class="space-y-3 max-h-80 overflow-y-auto pr-2">
                        ${feedbackHTML}
                    </div>

                    <button id="next-level-btn" class="mt-8 w-full px-6 py-3 bg-indigo-600 text-white text-lg font-bold rounded-xl btn-primary hover:bg-indigo-700">
                        ${nextBtnText}
                    </button>
                </div>
            `;

            document.getElementById('next-level-btn').addEventListener('click', () => {
                if (isCausesLevel) {
                    state.currentLevel = 1; // Move to Actions
                    state.view = 'actions';
                    startTimer(); // Restart timer for the next phase
                    renderGame();
                } else {
                    state.view = 'score';
                    renderGame();
                }
            });
        };

        const renderScoreScreen = () => {
            stopTimer();
            const isNewHighScore = saveHighScore();

            gameScreen.innerHTML = `
                <div class="text-center p-4">
                    <h2 class="text-4xl font-extrabold text-indigo-700 mb-4">Challenge Complete!</h2>
                    
                    <div class="my-6">
                        <p class="text-2xl font-bold text-gray-600">Final Score:</p>
                        <p class="text-6xl font-extrabold ${state.score > 0 ? 'text-green-600' : 'text-red-600'} mt-2">${state.score}</p>
                    </div>

                    <p class="text-xl font-semibold text-gray-700 mb-2">Time Taken: ${state.timer} seconds</p>

                    ${isNewHighScore ? `
                        <div class="bg-yellow-100 p-4 rounded-lg my-6 border-l-4 border-yellow-500">
                            <p class="text-2xl font-bold text-yellow-700">üèÜ NEW HIGH SCORE! üèÜ</p>
                            <p class="text-lg text-yellow-600">Previous Record: ${state.highScore} (before this round)</p>
                        </div>
                    ` : `
                        <div class="bg-indigo-50 p-4 rounded-lg my-6">
                            <p class="text-lg font-semibold text-indigo-700">Best Score to Beat: ${state.highScore}</p>
                        </div>
                    `}

                    <button id="play-again-btn" class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white text-lg font-bold rounded-xl btn-primary hover:bg-indigo-700 mt-4">
                        Play Again
                    </button>
                </div>
            `;

            document.getElementById('play-again-btn').addEventListener('click', () => {
                state.view = 'start';
                renderGame();
            });
        };


        // --- Main Render Loop ---
        const renderGame = () => {
            switch (state.view) {
                case 'start':
                    renderStartScreen();
                    break;
                case 'selection':
                    renderSelectionScreen();
                    break;
                case 'causes':
                case 'actions':
                    renderQuizScreen();
                    break;
                case 'score':
                    renderScoreScreen();
                    break;
                default:
                    renderStartScreen();
            }
        };

        // Initialize Game
        window.onload = renderGame;

    </script>
</body>
</html>
